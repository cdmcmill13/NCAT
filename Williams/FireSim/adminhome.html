<!DOCTYPE html>
<html>
<!-- Admininistrator home page-->
<head>
<title>FireSim Administrator</title>
</head>

<body>

<div>

<H3 id="alertMsg"></H3>

<!-- List of players -->
<p id = "pressNum">selected player</p>
<p onclick="getList()">Update list</p>
<br>
<table id="playerlist">
<thead>
<tr><th>select</th><th>Name</th><th>Score</th>
</tr>
</thead>
<tbody>
<tr><td><input type="radio" name="playerGroup" onclick="playerSelected(0)"></input>
</td><td>nobody</td><td>100</td></tr>
</tbody>
</table>

<!-- Send messages to players-->
<br>
<input type="text" maxlength="128" id="msgIn"><br>
<button type="button" onclick="sendMsg(false,1)">Send message</button>
<button type="button" onclick="sendMsg(true,1)">Send to all</button>
<button type="button" id="startstop" onclick="startstop()">Start</button>

<p>
<!-- New configuration tasks to be sent to the players -->
<button onclick="tellTask('ftpweb')" id="ftpweb" value='"text":"Allow FTP access to the web server, 152.8.1.1", "chgID":"ftp", "newval":"ftpweb"'>Task</button>Add an FTP on the web server<br>

<button onclick="tellTask('ftp')" id="ftp" value='"text":"The FTP server has been moved to A.firewall.edu, 152.8.4.4", "chgID":"ftp", "newval":"ftp"'>Task</button>Add a separate FTP server<br>

<button onclick="tellTask('altdns')" id="altdns" value='"text":"A backup DNS has been installed at 152.8.4.4", "chgID":"dns", "newval":"altdns"'>Task</button>Add a second DNS server<br>

<button onclick="tellTask('waste')" id="waste" value='"text":"Many employees are viewing the www.wasteoftime.com website (IP address 198.76.5.4).  Management wants you to prevent employees from accessing this website.", "chgID":"waste", "newval":"waste"'>Task</button>Prevent employee access to www.wasteoftime.com<br>

<button onclick="tellTask('pop')" id="pop" value='"text":"Allow employees to access the email server from offsite using the Post Office Protocol, POP3", "chgID":"waste", "newval":"waste"'>Task</button>Allow POP email access from offsite<br>

<button onclick="tellTask('imap')" id="imap" value='"text":"Allow employees to access the email server from offsite using the Internet Message Access Protocol, IMAP4", "chgID":"imap", "newval":"imap"'>Task</button>Allow IMAP email access from offsite<br>

<button onclick="tellTask('mydoom')" id="mydoom" value='"text":"Prevent the Mydoom malware from sending messages out on TCP port 3127", "chgID":"mydoom", "newval":"mydoom"'>Task</button>Prevent MyDoom backdoor access<br>

<button onclick="tellTask('vpn')" id="vpn" value='"text":"Allow outside Virtual Private Network (VPN) access to the Jane.firewall.edu computer, 152.8.100.2, using TCP ports 47, 1701 and 1723", "chgID":"vpn", "newval":"vpn"'>Task</button>Allow VPN access<br>
</p>

<script>
var listString = '{"players": [{ "name":"nobody", "score":"0" } ]}' ;
var playArray = JSON.parse( listString);			// array of players from server
var selectedPlayer = null;							// currently selected player

// playerSelected is called when a radio button in the player list is clicked
function playerSelected(who) {
	selectedPlayer = playArray.players[who].name;
}

// gteList requests a new list of players from the server
function getList() {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if (xhttp.readyState == 4 && xhttp.status == 200) {
			playArray = JSON.parse(xhttp.responseText);
			playerUpdate();
		}
	};
  xhttp.open("GET", "http://localhost/FireSim/refreshplayers.php", true);
  xhttp.send();
}

// playerUpdate refreshes the list of players from playArray created by getList()
// If a player was previously selected, their radio button remains selected.
function playerUpdate() {
	var tbl = "<thead><tr><th>Select</th><th>Name</th><th>Score</th></tr></thead><tbody>";
	var i;
	for (i = 0; i < playArray.players.length; i++) {
		tbl += '<tr><td><input type="radio" name="playerGroup" onclick="playerSelected('+ i +')"';
		if (selectedPlayer != null && selectedPlayer == playArray.players[i].name) {
			tbl += ' checked="true"';			// if this player previously selected
		}
		tbl += '></input></td><td>' + playArray.players[i].name + '</td><td>'  +
			playArray.players[i].score + '</td></tr>';
	}
	tbl += '</tbody></table>';
	document.getElementById("playerlist").innerHTML = tbl;
}

// Send a new configuration requirement to the players
function tellTask(dowhat) {
	var whatClick = document.getElementById(dowhat);
	msg2server(whatClick.value, "broadcast!", 8);		// send new config msg to server for all players
	whatClick.disabled = true;							// disable button, each reconfig allowed only once
}

// Send a message to the server to be sent to players 
// If $broad is true, then the message should be sent to all users
// If $broad is false, then the message is sent to the current selectedPlayer.
function sendMsg(broad, whatType) {
	var msg = document.getElementById("msgIn").value;		// get text of message
	if (msg.length ==0) {			// avoid empty messages
		document.getElementById("alertMsg").innerHTML = "Enter message text";
		return;
	}
	if (broad) {			// if this is a broadcast to all players 
		selectedPlayer = "broadcast!";
	} else {				// msg for single player
		if (selectedPlayer == null) {
			document.getElementById("alertMsg").innerHTML = "A player must be selected from the list";
			return;
		}
	}
	msg2server(msg, selectedPlayer, whatType);					// send message to the server
	document.getElementById("msgIn").value = "";		// erase message text 
	// It might be appropriate at this point to unclick the selected player
}

// Send a message to the server to be delivered to the player(s).
function msg2server(msgText, recipient, msgType) {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if (xhttp.readyState == 4 && xhttp.status == 200) {
			var fromServer = xhttp.responseText;			// response from server
			if (fromServer != "OK") {
				document.getElementById("alertMsg").innerHTML = xhttp.responseText;	// show message
			}
		}
	};
	xhttp.open("POST", "http://localhost/FireSim/adminSendMsg.php", true);
	xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
	xhttp.send("recipient=" + recipient + "&text=" + msgText + "&type=" + msgType);
}

/* When the start button is pressed, a messageis sent to all players.  If the administrator
 * has entered any text in the message field, it is sent as well.  If this is a start event,
 * then a type 9 message is sent and the text of the button is changed to "STOP".  Otherwise
 * a type 10 stop message is sent to everyone.
*/
function startstop() {
	var theButton = document.getElementById("startstop");
	var msg = document.getElementById("msgIn").value;		// get text of message
	if (msg.length ==0) {									// avoid empty messages
		document.getElementById("msgIn").value = theButton.innerHTML; // copy button text
	}
	var msgCode = 10;										// message type for stop 
	if (theButton.innerHTML == "Start") {					// if start of the simulation
		theButton.innerHTML = "STOP";						// change the button
		msgCode = 9;										// message type for start
	} else {
		theButton.innerHTML = "Start";						// reset the button to allow resuming simulation
		msgCode = 10;										// message type for stop
	}
	var msg = document.getElementById("msgIn").value;		// get text of message

	sendMsg(true, msgCode);									// send message to everyone
}
</script>

</div>

</body>

</html>
